---
layout: default
title: 异常检测
nav_order: 80
has_children: true
redirect_from:
  - /monitoring-plugins/ad/
  - /monitoring-plugins/ad/index/
---

# 异常检测

探索中的异常是您的时间上的任何异常行为变化-系列数据。异常可以为您的数据提供宝贵的见解。例如，对于IT基础架构数据，内存使用度量的异常可能会帮助您发现系统故障的早期迹象。

使用常规方法（例如创建可视化和仪表板）发现异常可能是一项挑战。您可以根据静态阈值配置警报，但这需要先前的域知识，并且不适合表现出有机生长或季节性行为的数据。

异常检测会自动检测您的OpenSearch数据中的异常-使用随机切割森林（RCF）算法的时间。RCF是一种无监督的机器学习算法`anomaly grade` 和`confidence score` 每个传入数据点的值。这些值用于区分异常与正常变化。有关RCF的工作方式的更多信息，请参阅[随机砍伐森林](https://www.semanticscholar.org/paper/Robust-Random-Cut-Forest-Based-Anomaly-Detection-on-Guha-Mishra/ecb365ef9b67cd5540cc4c53035a6a7bd88678f9)。

您可以将异常检测插件与[警报插件]({{site.url}}{{site.baseurl}}/monitoring-plugins/alerting/) 一旦检测到异常，请立即通知您。

要开始，请选择**异常检测** 在OpenSearch仪表板中。
要使用示例流数据进行首次测试，您可以使用其中一个示例数据集尝试了一个预配置的检测器。

## 步骤1：定义检测器

检测器是单个异常检测任务。您可以定义多个检测器，所有检测器都可以同时运行，每个检测器都分析来自不同来源的数据。

1. 选择**创建检测器**。
1. 添加探测器详细信息。
   - 输入名称和简短说明。确保名称是独一无二的，足以帮助您确定检测器的目的。
1. 指定数据源。
   - 为了**数据源**，选择要用作数据源的索引。您可以选择使用索引模式来选择多个索引。
   - （可选）**数据过滤器**，过滤您选择作为数据源的索引。来自**数据过滤器** 菜单，选择**添加数据过滤器**，然后通过选择您的过滤器查询**场地**，，，，**操作员**， 和**价值**，或选择**使用查询DSL** 并添加您自己的JSON过滤器查询。
1. 指定时间戳。
   - 选择**时间戳字段** 在您的索引中。
1. 定义操作设置。
   - 为了**操作设置**，定义**检测器间隔**，这是检测器收集数据的时间间隔。
      - 检测器以此间隔将数据聚集，然后将汇总结果馈送到异常检测模型中。
      您设置此间隔的较短，数据量越少，检测器聚合。
      异常检测模型使用了一种摇式过程，该过程使用连续数据点为模型创建样本的技术。此过程需要从连续的间隔中进行一定数量的汇总数据点。

      - 我们建议根据您的实际数据设置检测器间隔。如果太长时间了，它可能会延迟结果，如果太短，可能会错过一些数据。它也将没有足够数量的木瓦过程数据点。

   - （可选）要添加数据收集的额外处理时间，请指定**窗口延迟** 价值。
      - 该值告诉检测器，数据不是实时摄入的，而是在一定的延迟中摄入。设置窗口延迟以移动检测器间隔以解释此延迟。
      - 例如，假设检测器间隔为10分钟，并且将数据摄入了您的群集中，总延迟为1分钟。假设检测器在2:00运行。检测器试图从1:50到2:00获取最后10分钟的数据，但由于1-微小的延迟，它只能获得9分钟的数据，并错过了1:59到2:00的数据。将窗口延迟设置为1分钟，将间隔窗口转移到1:49--1:59，因此检测器解释了检测器间隔时间的所有10分钟。
1. 指定自定义结果索引。
   - 如果要存储异常检测结果，请选择**启用自定义结果索引** 并指定存储结果的自定义索引。异常检测插件添加了`opensearch-ad-plugin-result-` 输入的索引名称的前缀。例如，如果您输入`abc` 结果索引名称，最终索引名称为`opensearch-ad-plugin-result-abc`。

   您可以使用破折号”-”签名将命名空间分开以管理自定义结果索引权限。例如，如果您使用`opensearch-ad-plugin-result-financial-us-group1` 结果索引，您可以根据模式创建权限角色`opensearch-ad-plugin-result-financial-us-*` 代表"financial" 部门在颗粒处"us" 区域。
   {： 。笔记 }

      - 如果您指定的自定义索引尚不存在，则当您创建检测器并启动真实时，异常检测插件会创建此索引-时间或历史分析。
      - 如果自定义索引已经存在，则插件检查自定义索引的索引映射是否与异常结果文件匹配。您需要确保自定义索引具有有效映射，如下所示：[异常-结果](https://github.com/opensearch-project/anomaly-detection/blob/main/src/main/resources/mappings/anomaly-results.json)。
   - 要使用自定义结果索引选项，您需要以下权限：
      - `indices:admin/create` - 如果自定义索引已经存在，则不需要此。
      - `indices:data/write/index` - 您需要`write` 对异常检测插件的许可，以将结果写入单个自定义索引-实体检测器。
      - `indices:data/read/search` - 您需要`search` 许可，因为异常检测插件需要搜索自定义结果索引以显示异常检测UI的结果。
      - `indices:data/write/delete` - 由于检测器可能会产生大量异常结果，因此您需要`delete` 权限删除旧数据并保存磁盘空间。
      - `indices:data/write/bulk*` -  您需要`bulk*` 许可，因为异常检测插件使用批量API将结果写入自定义索引。
   - 管理自定义结果索引：
      - 异常检测仪表板查询所有检测器的所有自定义结果索引的结果。具有太多自定义结果索引可能会影响异常检测插件的性能。
      - 您可以使用[索引状态管理]({{site.url}}{{site.baseurl}}/im-plugin/ism/index/) 滚动旧结果索引。您也可以手动删除或存档任何旧结果索引。我们建议重复多个检测器的自定义结果索引。
1. 选择**下一个**。

定义检测器后，下一步是配置模型。

## 步骤2：配置模型

#### 在检测器中添加功能

一个功能是要检查异常的索引中的字段。检测器可以发现一个或多个功能的异常。您必须为每个功能选择一个聚合方法：`average()`，，，，`count()`，，，，`sum()`，，，，`min()`， 或者`max()`。聚合方法确定什么构成异常。

例如，如果您选择`min()`，该检测器的重点是基于功能的最低值查找异常。如果您选择`average()`，检测器根据功能的平均值找到异常。

并发-特征模型将其所有功能的异常相关联。这[维度的诅咒](https://en.wikipedia.org/wiki/Curse_of_dimensionality) 使多数的可能性较小-特征模型与单个相比识别较小的异常-功能模型。添加更多功能可能会对[精确和回忆](https://en.wikipedia.org/wiki/Precision_and_recall) 模型。数据中较高比例的噪声可能会进一步扩大这种负面影响。选择最佳功能集通常是迭代过程。默认情况下，检测器的最大功能数为5。您可以使用`plugins.anomaly_detection.max_anomaly_features` 环境。
{： 。笔记 }

要配置基于聚合方法的异常检测模型，请按照以下步骤：

1. 在**配置模型** 页面，输入**功能名称** 并检查**启用功能**。
1. 为了**根据基于**， 选择**场值**。
1. 为了**聚合方法**，选择**平均的（）**，，，，**数数（）**，，，，**和（）**，，，，**最小（）**， 或者**最大限度（）**。
1. 为了**场地**，从可用选项中选择。

要根据JSON聚合查询配置异常检测模型，请按照以下步骤：
1. 在**配置模型** 页面，输入**功能名称** 并检查**启用功能**。
1. 为了**根据基于**， 选择**自定义表达式**。您将看到JSON编辑窗口打开。
1. 在编辑器中输入您的JSON聚合查询。

有关可接受的JSON查询语法，请参阅[OpenSearch查询DSL]({{site.url}}{{site.baseurl}}/opensearch/query-dsl/index/)
{： 。笔记 }

#### （可选的）高基数的设置类别字段

您可以根据关键字或IP字段类型对异常进行分类。

类别字段将源时间序列分类或切成诸如IP地址，产品ID，国家代码等的维度。这有助于查看类别字段每个实体内部的异常情况，以隔离和调试问题。

要设置类别字段，请选择**启用类别字段** 并选择一个字段。创建检测器后，您无法更改类别字段。

在类别字段中仅支持一定数量的唯一实体。使用以下方程来计算群集中支持的实体总数：

```
(data nodes * heap size * anomaly detection maximum memory percentage) / (entity model size of a detector)
```

要获取检测器的实体模型大小，请使用[配置文件检测器API]({{site.url}}{{site.baseurl}}/monitoring-plugins/ad/api/#profile-detector)。您可以使用`plugins.anomaly_detection.model_max_size_percent` 环境。

该公式提供了一个很好的起点，但请确保使用代表性工作量进行测试。
{： 。笔记 }

例如，对于具有三个数据节点的群集，每个群集具有8 GB的JVM堆大小，最大内存百分比为10％（默认）和检测器的实体模型大小为1MB：所支持的独特实体的总数为（8.096 * 10^9 * 0.1 / 1 MB） * 3 = 2429。

如果实际总体的实际总数高于您计算的该数字（在这种情况下：2429），则异常检测器将尽力为额外的实体建模。探测器优先考虑发生更频繁并且更新的实体。

#### （高级设置）设置木尺寸

从数据流中设置聚合间隔的数量，以在检测窗口中考虑。最好根据您的实际数据选择此值，以查看哪些为您的用例带来最佳结果。

异常检测器期望木架尺寸在1和60范围内。默认的木瓦大小为8。我们建议您选择1个或更多功能，否则您不要选择1。较小的值可能会增加[记起](https://en.wikipedia.org/wiki/Precision_and_recall) 而且还假阳性。较大的值可能对于忽略信号中的噪声可能很有用。

#### 预览样品异常

预览示例异常，并在需要时调整功能设置。
对于示例预览，异常检测插件选择了少数数据示例---例如，每30分钟一个数据点---并使用插值来估计其余数据点以近似实际特征数据。它将此样品数据集加载到检测器中。检测器使用此样品数据集生成异常结果的样本预览。

检查样品预览并使用它来罚款-调整您的功能配置（例如，启用或禁用功能）以获得更准确的结果。

1. 选择**预览样品异常**。
    - 如果您没有看到任何样本异常结果，请检查检测器间隔，并确保在预览日期范围内某些实体有400多个数据点。
1. 选择**下一个**。

## 步骤3：设置检测器作业

开始真实-时间探测器在您的数据中找到异常-时间，检查**开始真实-时间检测器自动（建议）**。

另外，如果您想执行历史分析并在长长的历史数据窗口（几周或几个月）中找到模式，请检查**运行历史分析检测** 并选择一个日期范围（至少128个检测间隔）。

分析历史数据可以帮助您熟悉异常检测插件。您还可以评估具有历史数据的探测器的性能-调整它。

我们建议使用不同功能集进行历史分析进行实验，并在转到真实之前检查精度-时间探测器。

## 步骤4：查看并创建

查看您的检测器设置和模型配置，以确保它们有效，然后选择**创建检测器**。

![异常检测结果]({{site.url}}{{site.baseurl}}/images/review_ad.png)

如果您看到任何验证错误，请编辑设置以修复错误，然后返回此页面。
{： 。笔记 }

## 步骤5：观察结果

选择**真实的-时间结果** 或者**历史分析** 标签。真正的-时间结果，您需要等待一些时间才能查看异常结果。如果检测器间隔为10分钟，则检测器可能需要超过一个小时的时间，因为它等待足够的数据生成异常。

较短的间隔意味着该模型会更快地通过木瓦过程，并开始更快地产生异常结果。
使用[配置文件检测器]({{site.url}}{{site.baseurl}}/monitoring-plugins/ad/api#profile-detector) 操作以确保您有足够的数据点。

如果您看到探测器正在等待"initialization" 在超过一天的时间内，使用检测器间隔来汇总现有数据，以检查任何丢失的数据点。如果您从汇总数据中找到很多缺少的数据点，请考虑增加检测器间隔。

选择并在异常线图上进行拖动以放大并查看异常的更详细的视图。
{： 。笔记 }

通过以下可视化分析异常：

- **现场异常** （真正的-时间结果）显示最后60个间隔的现场异常结果。例如，如果间隔为10，则显示最后600分钟的结果。图表每30秒刷新一次。
- **异常概述** （真正的-时间结果） /**异常历史**  （用于历史分析**历史分析** TAB）以相应的置信度度量绘制异常等级。该窗格包括：
    - 基于给定数据的异常发生数量-时间范围。
    - 这**平均异常等级**，指示数据点异常的0到1之间的数字。异常等级为0表示“不是异常”，而不是-零值表示异常的相对严重程度。
    - **信心** 估计报告异常等级与预期异常等级相匹配。随着模型观察更多数据并了解数据行为和趋势，置信度增加了。请注意，置信度与模型准确性不同。
    - **上次异常发生** 是最后一次异常发生的时间。

下**异常概述**/**异常历史** 是：

- **功能故障** 绘制基于聚合方法的功能。您可以改变日期-检测器的时间范围。在功能线图上选择一个点显示**功能输出**，索引中出现字段的次数，**期望值**，功能输出的预测值。如果没有异常，则输出和期望值相等。

    ![异常检测结果]({{site.url}}{{site.baseurl}}/images/feature-contribution-ad.png)

- **异常发生** 显示`Start time`，，，，`End time`，，，，`Data confidence`， 和`Anomaly grade` 对于每个检测到的异常。

在异常线图上选择一个点显示**功能贡献**，导致异常的功能的百分比

![异常检测结果]({{site.url}}{{site.baseurl}}/images/feature-contribution-ad.png)


如果设置类别字段，您会看到其他**热图** 图表。热图将异常实体的结果相关联。此图表为空，直到您选择一个异常实体为止。您还可以看到异常时间段的异常和功能线图（`anomaly_grade` > 0）。


如果您设置了多个类别字段，则可以选择一个字段的子集来过滤和对字段进行分类。选择一个字段的子集使您可以看到一个字段的最高值，该字段与另一个字段共享一个共同值。

例如，如果您有一个带有类别字段的检测器`ip` 和`endpoint`，您可以选择`endpoint` 在里面**查看** 下拉式菜单。然后选择一个特定的单元格以覆盖最高的20个值`ip` 在图表上。异常检测插件选择顶部`ip` 默认情况下。您最多可以看到5个单独的时间-串联值同时。

## 步骤6：设置警报

在下面**真实的-时间结果**， 选择**设置警报** 并配置监视器以在检测到异常时通知您。有关创建监视器并根据您的异常检测器设置通知的步骤，请参见[监视器]({{site.url}}{{site.baseurl}}/observing-your-data/alerting/monitors/)。

如果您停止或删除检测器，请确保删除与之相关的任何显示器。

## 步骤7：调整模型

要查看检测器的所有配置设置，请选择**检测器配置** 标签。

1. 要对检测器配置进行任何更改，或微调时间间隔以最大程度地减少任何误报，请转到**检测器配置** 部分选择**编辑**。
- 你需要停止真实-时间和历史分析以改变其配置。确认您要停止检测器并继续进行。
1. 启用或禁用功能**特征** 部分，选择**编辑** 并根据需要调整功能设置。进行更改后，选择**保存并开始检测器**。

## 步骤8：管理检测器

要开始，停止或删除检测器，请转到**探测器** 页。

1. 选择检测器名称。
2. 选择**动作** 并选择**开始真实-时间探测器**，，，，**停止真实-时间探测器**， 或者**删除探测器**。

